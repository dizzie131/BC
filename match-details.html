<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Details</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .highlight {
            background-color: #FEBE10;
        }
        .foul-red {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Match Details</h1>
    <div id="match-details-container">
        <!-- Match details will be populated here -->
    </div>

    <script>
        // Function to get URL parameters
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        const matchId = getQueryParam('matchId');

        if (matchId) {
            // Fetching match events based on the matchId
            fetch(`https://api-basketball.squadi.com/livescores/matches/public/events?matchId=${matchId}`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('match-details-container');
                    const playerFouls = {}; // Object to track personal fouls
                    let teamScores = { 63189: 0, 63366: 0 }; // Initialize team scores
                    let eventsByQuarter = {}; // Object to organize events by quarter

                    // Check if data has the expected structure
                    if (data && Array.isArray(data)) {
                        data.forEach(event => {
                            const { timestamp, teamId, displayName, players, period } = event;
                            const periodId = period?.id; // Use optional chaining to avoid errors

                            // Initialize quarter object if not exists
                            if (!eventsByQuarter[periodId]) {
                                eventsByQuarter[periodId] = [];
                            }

                            // Check for player fouls and update the playerFouls object
                            if (displayName === "Personal Foul" && players.length > 0) {
                                const player = players[0];
                                playerFouls[player.shirt] = (playerFouls[player.shirt] || 0) + 1;
                                eventsByQuarter[periodId].push({
                                    displayName: `${displayName} [${playerFouls[player.shirt]}]`,
                                    shirt: player.shirt,
                                    teamId,
                                    timestamp,
                                    isFoul: true
                                });
                            } else if (players.length > 0) {
                                // Ensure player exists before accessing
                                const player = players[0];
                                eventsByQuarter[periodId].push({
                                    displayName,
                                    shirt: player.shirt,
                                    teamId,
                                    timestamp,
                                    isFoul: false
                                });
                            }

                            // Update team scores based on scoring events
                            if (displayName === "2 Points Made") {
                                teamScores[teamId] += 2; // Add 2 points for scoring
                            } else if (displayName === "3 Points Made") {
                                teamScores[teamId] += 3; // Add 3 points for scoring
                            }
                        });

                        // Generate HTML for events
                        let html = '<table><thead><tr><th>Quarter</th><th>Event</th><th>Player Shirt</th><th>Team ID</th></tr></thead><tbody>';
                        
                        Object.keys(eventsByQuarter).forEach(period => {
                            const events = eventsByQuarter[period];
                            events.forEach(event => {
                                const eventDisplay = event.isFoul && playerFouls[event.shirt] === 5 
                                    ? `<span class="foul-red">${event.displayName}</span>`
                                    : event.displayName;
                                html += `<tr>
                                    <td>${period}</td>
                                    <td>${eventDisplay}</td>
                                    <td>${event.shirt}</td>
                                    <td>${event.teamId}</td>
                                </tr>`;
                            });
                        });

                        html += '</tbody></table>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<p>No match data available.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching match details:', error);
                    document.getElementById('match-details-container').innerHTML = '<p>Error loading match details.</p>';
                });
        } else {
            document.getElementById('match-details-container').innerHTML = '<p>No match ID provided.</p>';
        }
    </script>
</body>
</html>
