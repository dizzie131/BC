<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Stats Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f4f4f4;
        }
        textarea {
            width: 100%;
            height: 150px;
            margin-bottom: 20px;
        }
        img {
            width: 35px; /* Team logo size */
            height: 35px;
        }
        .foul-limit {
            color: red;
            font-weight: bold;
        }
        #matchid-container {
            margin-bottom: 20px;
        }
        canvas {
            max-width: 600px; /* Adjust as needed */
            margin: auto;
        }
    </style>
</head>
<body>

<h1>Game Stats Report</h1>

<!-- Match ID input box and button -->
<div id="matchid-container">
    <input type="text" id="matchid-input" placeholder="Enter Match ID" />
    <button onclick="fetchMatchData()">Fetch Match Data</button>
</div>

<textarea id="json-input" placeholder="Paste JSON data here..."></textarea>
<button onclick="processData()">Process Data</button>

<h2>Game Stats Report</h2>
<canvas id="scoreChart"></canvas>
<div id="output-container"></div>

<script>
let teamLogos = {}; // Object to store team logos
let team1Score = 0;
let team2Score = 0;
let labels = [];
let team1Scores = [];
let team2Scores = [];
let team1Id;
let team2Id;

// Function to fetch team logos
async function fetchTeamLogos() {
    const url = 'https://api-basketball.squadi.com/livescores/teams/ladder/v2?divisionIds=9665&competitionKey=57857f42-2493-49ad-9396-5471910edeb3&filteredOutCompStatuses=1&showForm=1&sportRefId=2';
    
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        const data = await response.json();

        // Populate teamLogos object with team ID and logo URL
        data.ladders.forEach(ladder => {
            teamLogos[ladder.id] = ladder.logoUrl; // Use ladder.id for team ID
        });
    } catch (error) {
        alert('Error fetching team logos: ' + error.message);
    }
}

// Fetch match data function
async function fetchMatchData() {
    const matchId = document.getElementById('matchid-input').value;
    const url = `https://api-basketball.squadi.com/livescores/matches/public/events?matchId=${matchId}`;
    
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        const data = await response.json();

        // Place the fetched JSON into the textarea
        document.getElementById('json-input').value = JSON.stringify(data, null, 2);
        return data; // Return fetched data
    } catch (error) {
        alert('Error fetching match data: ' + error.message);
    }
}

// Process data function
async function processData() {
    await fetchTeamLogos();

    const jsonData = document.getElementById('json-input').value;

    try {
        const data = JSON.parse(jsonData);
        const outputContainer = document.getElementById('output-container');
        outputContainer.innerHTML = ''; // Clear previous output

        // Extract team IDs from the match data
        if (data && data.length > 0) {
            team1Id = data[0].team1Id; // Adjust based on actual JSON structure
            team2Id = data[0].team2Id; // Adjust based on actual JSON structure
        }

        // Initialize scores and labels
        labels = [];
        team1Scores = [];
        team2Scores = [];

        // Sort events by timestamp (ascending)
        data.sort((a, b) => a.timestamp - b.timestamp);

        // Initialize team scores
        team1Score = 0;
        team2Score = 0;

        // Create tables for each quarter and collect score data
        data.forEach(event => {
            const eventTimestamp = new Date(event.timestamp * 1000).toLocaleTimeString(); // Convert to readable time
            labels.push(eventTimestamp); // Add timestamp to labels

            if (event.stat.displayName.includes("Score")) {
                if (event.teamId === team1Id) {
                    team1Score += event.score;
                } else if (event.teamId === team2Id) {
                    team2Score += event.score;
                }
            }

            // Store scores for the graph
            team1Scores.push(team1Score);
            team2Scores.push(team2Score);
        });

        // Create the line graph
        createScoreChart();
    } catch (error) {
        alert('Invalid JSON data. Please check the format and try again.');
    }
}

// Function to create the score chart
function createScoreChart() {
    const ctx = document.getElementById('scoreChart').getContext('2d');
    const scoreChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Team 1 Score', // Adjust team names accordingly
                    data: team1Scores,
                    borderColor: 'blue',
                    fill: false,
                },
                {
                    label: 'Team 2 Score',
                    data: team2Scores,
                    borderColor: 'red',
                    fill: false,
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Time'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Score'
                    }
                }
            }
        }
    });
}

// Function to get URL parameters
function getQueryParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

// On page load, populate the match ID if available and automatically fetch and process data
window.onload = async function() {
    const matchId = getQueryParameter('matchId');
    if (matchId) {
        document.getElementById('matchid-input').value = matchId; // Set the matchId in the textbox
        const data = await fetchMatchData(); // Automatically fetch match data
        await processData(); // Automatically process data
    }
};
</script>
</body>
</html>
